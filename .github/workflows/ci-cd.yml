name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Дозволяє запускати вручну

jobs:
  build-and-test:
    name: Build and Test (Debug)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up CMake
        uses: lukka/get-cmake@latest

      - name: Configure CMake for Debug
        run: |
          cmake -B build-debug -S . \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="-march=native -mavx -mavx2" \
            -DMATH_LIBRARY_BUILD_TESTS=ON \
            -DMATH_LIBRARY_INCLUDE_G_TEST=ON \
            -DMATH_LIBRARY_INCLUDE_SPDLOG=OFF \
            -DMATH_LIBRARY_INCLUDE_G_BENCHMARK=OFF

      - name: Build project (Debug)
        run: cmake --build build-debug --config Debug

      - name: Run tests
        run: ./build-debug/math_library_exe

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build-debug/
          retention-days: 7

  build-release:
    name: Build Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up CMake
        uses: lukka/get-cmake@latest

      - name: Configure CMake for Release
        run: |
          cmake -B build-release -S . \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_FLAGS="-march=native -mavx -mavx2 -O3" \
            -DMATH_LIBRARY_BUILD_TESTS=OFF

      - name: Build project (Release)
        run: cmake --build build-release --config Release

      - name: Upload release build
        uses: actions/upload-artifact@v4
        with:
          name: release-build
          path: build-release/
          retention-days: 7

  package-and-release:
    name: Package and Release
    needs: [build-and-test, build-release]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current date and commit
        id: date
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Create release package
        run: |
          mkdir -p release_package
          cp -r include release_package/
          cp CMakeLists.txt release_package/
          cp README.md release_package/
          cp -r scripts release_package/
          mkdir -p release_package/src
          cp -r src/lib release_package/src/
          cd release_package
          tar -czf ../math_library-${{ steps.date.outputs.date }}-${{ steps.date.outputs.sha_short }}.tar.gz *

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ steps.date.outputs.date }}-${{ steps.date.outputs.sha_short }}
          name: Build ${{ steps.date.outputs.date }} (${{ steps.date.outputs.sha_short }})
          body: |
            Automated release from CI/CD pipeline

            **Commit:** ${{ github.sha }}
            **Date:** ${{ steps.date.outputs.date }}

            This release contains the header-only math library with SIMD support.

            ## Installation
            1. Download and extract the archive
            2. Include in your CMake project using FetchContent or add_subdirectory

            ## Changes
            See commit history for details: ${{ github.event.compare }}
          files: |
            math_library-${{ steps.date.outputs.date }}-${{ steps.date.outputs.sha_short }}.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}